<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Add this line in the <head> section of your Sentiment Final.html -->
    <link rel="stylesheet" href="sentiment-responsive.css">
    <title>Sentiment Analysis Results - EarningsAI</title>
    <style>
        * {margin:0; padding:0; box-sizing:border-box;}
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#2c2c2c 0%,#1a1a1a 100%);min-height:100vh;color:#fff;}
        .container{max-width:1400px;margin:0 auto;padding:0 20px;}
        .header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.3);position:sticky;top:0;z-index:100;}
        .nav{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;}
        .logo{font-size:1.8rem;font-weight:700;background:linear-gradient(135deg,#e53e3e,#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .nav-links{display:flex;gap:2rem;list-style:none;}
        .nav-links a{text-decoration:none;color:#ccc;font-weight:500;transition:color 0.3s ease;}
        .nav-links a:hover{color:#e53e3e;}
        .main-content{padding:2rem 0;}
        .results-header{background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border-radius:16px;padding:2rem;margin-bottom:2rem;border:1px solid rgba(255,255,255,0.1);}
        .file-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
        .file-details h2{color:#fff;font-size:1.5rem;margin-bottom:0.5rem;}
        .file-meta{color:#ccc;font-size:0.9rem;}
        .summary-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem;}
        .stat-card{background:rgba(255,255,255,0.03);padding:1rem;border-radius:12px;text-align:center;border:1px solid rgba(255,255,255,0.05);}
        .stat-number{font-size:2rem;font-weight:700;margin-bottom:0.5rem;}
        .positive .stat-number{color:#4CAF50;}
        .negative .stat-number{color:#e53e3e;}
        .neutral .stat-number{color:#FFC107;}
        .stat-label{color:#ccc;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;}
        .sentiment-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .sentiment-column {
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            height: 80vh;
            min-width: 0;
            overflow: hidden;
            position: relative;
        }
        .column-header {
            position: sticky;
            top: 0;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            background: #232323;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        /* Make the card container scrollable beneath the sticky header */
        .column-header + div {
            flex: 1 1 auto;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        .phrase-card{
            background:rgba(255,255,255,0.03);
            border-radius:12px;
            padding:1.5rem;
            margin:1rem 1.5rem 1rem 1.5rem;
            border:1px solid rgba(255,255,255,0.05);
            transition:all 0.3s ease;
            cursor:pointer;
        }
        .phrase-card:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3);}
        .phrase-text{color:#fff;font-size:1rem;line-height:1.5;margin-bottom:1rem;}
        .phrase-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
        .timestamp{color:#999;font-size:0.85rem;font-family:'Courier New',monospace;}
        .confidence-score{background:rgba(255,255,255,0.1);padding:0.25rem 0.75rem;border-radius:20px;font-size:0.8rem;color:#fff;}
        .audio-controls{display:flex;align-items:center;gap:0.75rem;}
        .audio-player{width:100%;margin-top:0.5rem;background:#333;border-radius:4px;}
        .play-btn{background:linear-gradient(135deg,#2c2c2c,#e53e3e);color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(229,62,62,0.3);}
        .play-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(229,62,62,0.4);}
        .stop-btn{background:linear-gradient(135deg,#e53e3e,#2c2c2c);color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;margin-left:4px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(229,62,62,0.3);}
        .stop-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(229,62,62,0.4);}
        .audio-info{color:#ccc;font-size:0.8rem;}
        .context-label{color:#999;font-size:0.75rem;font-style:italic;}
        .sentiment-column::-webkit-scrollbar{width:6px;}
        .sentiment-column::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:3px;}
        .sentiment-column::-webkit-scrollbar-thumb{background:rgba(229,62,62,0.6);border-radius:3px;}
        .sentiment-column::-webkit-scrollbar-thumb:hover{background:rgba(229,62,62,0.8);}
        .loading{text-align:center;color:#ccc;font-style:italic;padding:2rem;}
        @media (max-width: 1024px) {
            .sentiment-columns {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .sentiment-column {
                max-height: none;
                height: auto;
            }
            .column-header {
                font-size: 1rem;
                padding: 1rem;
            }
            .phrase-card {
                padding: 1rem;
                margin: 0.5rem 1rem;
            }
        }
        @media (max-width: 600px) {
            .column-header {
                font-size: 1rem;
                padding: 1rem;
            }
            .phrase-card {
                padding: 1rem;
                margin: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">ðŸ“Š EarningsAI</div>
                <ul class="nav-links">
                    <li><a href="#upload">Upload New</a></li>
                    <li><a href="#export">Export Results</a></li>
                    <li><a href="#settings">Settings</a></li>
                    <li><a href="#help">Help</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main class="main-content">
        <div class="container">
            <div class="results-header">
                <div class="file-info">
                    <div class="file-details">
                        <h2 id="fileTitle">Earnings Call Results</h2>
                        <div class="file-meta" id="fileMeta"></div>
                    </div>
                </div>
                <div class="summary-stats">
                    <div class="stat-card positive">
                        <div class="stat-number" id="statPositive">0</div>
                        <div class="stat-label">Positive</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-number" id="statNegative">0</div>
                        <div class="stat-label">Negative</div>
                    </div>
                    <div class="stat-card neutral">
                        <div class="stat-number" id="statNeutral">0</div>
                        <div class="stat-label">Neutral</div>
                    </div>
                </div>
            </div>
            <div class="sentiment-columns">
                <div class="sentiment-column positive">
                    <div class="column-header">
                        <div class="column-icon">+</div>
                        <h3 class="column-title">Positive Sentiments</h3>
                    </div>
                    <div id="positiveCards"></div>
                </div>
                <div class="sentiment-column negative">
                    <div class="column-header">
                        <div class="column-icon">âˆ’</div>
                        <h3 class="column-title">Negative Sentiments</h3>
                    </div>
                    <div id="negativeCards"></div>
                </div>
                <div class="sentiment-column neutral">
                    <div class="column-header">
                        <div class="column-icon">â€¢</div>
                        <h3 class="column-title">Neutral Sentiments</h3>
                    </div>
                    <div id="neutralCards"></div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
    // --------- CONFIGURE THESE ---------
    const SUPABASE_URL = "https://ptgthmbqqkksnspbxwnb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Z3RobWJxcWtrc25zcGJ4d25iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNTU5MjIsImV4cCI6MjA3MzYzMTkyMn0.DKpIZ3TmCucOoVmEBLSAtdqv_A3Uk5P6t9VYFqcf624";
    const BUCKET_NAME = 'processed_audio';
    const TABLE_NAME = 'audio_files';

    // Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utility: get query param
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }
    const fileId = getQueryParam("id") || "audio";

    // Fetch all comments for this file prefix
    async function fetchComments(prefix) {
        let { data, error } = await supabase
            .from(TABLE_NAME)
            .select('*')
            .eq('unique_prefix', prefix);

        if (error) {
            console.error("Supabase DB error:", error);
            return [];
        }
        return data;
    }

    // Fetch public URL for audio filename from Supabase Storage
    async function getAudioUrl(filename) {
        const { data, error } = await supabase.storage.from(BUCKET_NAME).getPublicUrl(filename);
        if (error || !data) {
            console.error("Supabase audio error:", error);
            return null;
        }
        return data.publicUrl;
    }

    // Render one phrase card
    async function renderCard(row, idx, sentiment) {
        const cardId = `${sentiment}-card-${idx+1}`;
        const audioUrl = await getAudioUrl(row.filename);

        return `
            <div class="phrase-card" id="${cardId}">
                <div class="phrase-text">${row.comment}</div>
                <div class="phrase-meta">
                    <span class="timestamp"></span>
                    <span class="confidence-score"></span>
                </div>
                <div class="audio-controls">
                    <audio class="audio-player" src="${audioUrl || ''}" controls></audio>
                </div>
            </div>
        `;
    }

    // Main function to render UI
    async function showSentimentResults() {
        const prefix = fileId;

        // Fetch all DB rows for this file
        const rows = await fetchComments(prefix);

        // Group by sentiment type
        const commentsByType = { positive: [], negative: [], neutral: [] };
        rows.forEach(row => {
            if (row.filename.includes("_positive_")) commentsByType.positive.push(row);
            else if (row.filename.includes("_negative_")) commentsByType.negative.push(row);
            else commentsByType.neutral.push(row);
        });

        // Update stats
        document.getElementById('statPositive').textContent = commentsByType.positive.length;
        document.getElementById('statNegative').textContent = commentsByType.negative.length;
        document.getElementById('statNeutral').textContent = commentsByType.neutral.length;

        // Render all cards
        for (const sentiment of ['positive', 'negative', 'neutral']) {
            const cardsHTML = await Promise.all(commentsByType[sentiment].map((row, idx) => renderCard(row, idx, sentiment)));
            document.getElementById(`${sentiment}Cards`).innerHTML = cardsHTML.join('');
        }
    }

    window.addEventListener('DOMContentLoaded', showSentimentResults);
    </script>
</body>
</html>